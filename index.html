<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Накладная “ONE TO ONE” — v24 (мобайл фикс, 5/лист, шапки видны, total не уезжает)</title>
<style>
:root{
  --line:#cfd8e3; --head:#e6f0ff; --sum:#f7f7f7;
  --chocb:rgba(93,50,23,.15); --chocbg:rgba(93,50,23,.03);
  --fs:12px; --pad:6px;
}

/* -------- ПЕЧАТЬ: ровно 5 строк на А4, total на той же странице -------- */
@media print{
  @page{ size:A4 portrait; margin:6mm }
  *{ -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body{ font-size:9.5px; margin:0 }
  /* Скрываем интерфейс на печати */
  .toolbar,.filectrl,.chips,.selctl,.delrow,.preview-exit{ display:none !important }
  header{ padding:0 0 2mm 0; border:none }
  h1{ margin:0 0 2mm 0; text-align:center; font-size:14px; letter-spacing:.3px }
  /* Строка товара: фикс-высота 47мм ⇒ стабильно 5 строк + итог влезает */
  .row{
    display:grid; grid-template-columns:48mm 1fr;
    height:47mm;
    gap:2mm; padding:1.8mm; margin:0 0 1mm 0; border:1px solid var(--line);
    border-radius:3px; align-items:center; break-inside:avoid;
  }
  /* НЕ форсируем разрыв после каждой 5-й — иначе total уезжал на новую страницу */
  .left{height:100%; display:flex; align-items:center; justify-content:center;}
  .imgbox{
    width:43mm; height:27mm; border:0.4mm solid var(--chocb);
    background:var(--chocbg); border-radius:2mm; display:flex; align-items:center; justify-content:center; overflow:hidden
  }
  .imgbox img{ width:100%; height:100%; object-fit:contain; object-position:center }
  .table{ border:1px solid var(--line); border-radius:2px; overflow:hidden }
  .trow{ display:grid; grid-template-columns:repeat(4,1fr); border-bottom:1px solid var(--line) }
  .trow.head,.trow.subhead{ background:var(--head); font-weight:700; text-transform:uppercase; font-size:10px }
  .tcell{ border-right:1px solid var(--line); padding:2px 3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .trow .tcell:last-child{ border-right:none }
  .trow.summary .tcell{ background:#fff }
  .tcell input,.tcell select{ height:16px; line-height:16px; font-size:9.5px; padding:0 3px; width:100%; border:1px solid #e5e7eb; border-radius:2px }
  .sumcell{ background:var(--sum); font-weight:800; text-align:right }
  .gtotal{
    margin-top:2mm; display:flex; justify-content:flex-end; gap:6px; font-weight:900;
    break-inside: avoid;
  }
  #grand{ font-weight:900 }
}

/* -------- Экран (ПК + мобайл) -------- */
*{ box-sizing:border-box }
body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; color:#111; font-size:var(--fs) }
header{ padding:10px 10px 6px; background:#f7fafc; border-bottom:1px solid #e5e7eb; position:sticky; top:0; z-index:2 }
h1{ margin:0; text-align:center; font-size:22px; text-transform:uppercase }
.toolbar{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:8px }
button,input,select{ font-size:var(--fs); padding:var(--pad); border:1px solid #cfd8e3; border-radius:8px; background:#fff }
button.primary{ background:#0f62fe; color:#fff; border-color:#0f62fe }
button.danger{ background:#ef4444; color:#fff; border-color:#ef4444 }
button.secondary{ background:#eef2ff }
.preview-exit{ display:none; position:fixed; right:10px; top:10px; z-index:5; padding:8px 10px; border-radius:8px; border:1px solid #94a3b8; background:#ffffffcc }
body.print-preview .preview-exit{ display:block }

main{ padding:10px }
.row{
  display:grid; grid-template-columns:180px 1fr;
  min-height:180px; gap:8px; border:1px solid var(--line); border-radius:10px;
  padding:8px; margin-bottom:8px; background:#fff; position:relative; align-items:center
}
.selctl{ position:absolute; left:8px; top:8px; display:flex; gap:6px; font-size:11px }
.delrow{ position:absolute; right:8px; top:8px; padding:4px 8px; border-radius:8px; border:1px solid #ef4444; color:#ef4444; background:#fff; cursor:pointer }
.left{ display:flex; flex-direction:column; align-items:center; gap:6px }
.imgbox{
  width:170px; height:113px; border:1px solid var(--chocb); background:var(--chocbg);
  border-radius:8px; overflow:hidden; display:flex; align-items:center; justify-content:center
}
.imgbox img{ width:100%; height:100%; object-fit:contain; object-position:center }
.filectrl{ width:100% }

.right{ display:grid; gap:6px }
.table{ display:grid; border:1px solid var(--line); border-radius:8px; overflow:hidden }
.trow{ display:grid; grid-template-columns:repeat(4,1fr); border-bottom:1px solid var(--line) }
.tcell{ border-right:1px solid var(--line); padding:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
.trow .tcell:last-child{ border-right:none }
.trow.head{ background:var(--head); font-weight:700; text-transform:uppercase; font-size:11px }
.trow.subhead{ background:#f8fafc; font-weight:700; text-transform:uppercase; font-size:11px }
.trow.summary{ background:#fff }
.tcell input,.tcell select{ width:100%; padding:4px; font-size:12px }
.sumcell{ background:var(--sum); font-weight:800; text-align:right }
.gtotal{ display:flex; justify-content:flex-end; align-items:center; gap:10px; padding:10px 12px; border:2px solid var(--line); border-radius:10px; background:#fff; margin-top:6px }
#grand{ font-weight:900; font-size:16px }

.chips{ display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px }
.chip{ background:#f1f5f9; border:1px solid #d1d9e6; border-radius:999px; padding:4px 8px; cursor:pointer; user-select:none }
.chip.active{ background:#0f62fe; color:#fff; border-color:#0f62fe }

/* ---- Мобильная адаптация: шапки полей не скрываем! ---- */
@media (max-width:640px){
  h1{ font-size:18px }
  .toolbar button{ flex:1 1 48%; min-width:44% }
  .row{ grid-template-columns:1fr; align-items:start }
  .imgbox{ width:100%; height:50vw; max-height:280px }
  .trow{ grid-template-columns:1fr 1fr }       /* две колонки на мобиле */
  /* НЕ скрываем шапки (раньше из-за этого не было видно “Категория/Марка”) */
  .tcell input,.tcell select{ font-size:16px; padding:10px }
  #grand{ font-size:20px }
}
</style>
</head>
<body>
<button class="preview-exit" onclick="togglePreview()">⟵ Выйти из предпросмотра</button>

<header>
  <h1>НАКЛАДНАЯ “ONE TO ONE”</h1>
  <div class="toolbar">
    <button class="primary" onclick="addRow()">Добавить позицию</button>
    <button onclick="removeSelected()">Удалить выбранные</button>
    <button class="danger" onclick="removeAll()">Удалить все</button>
    <button class="secondary" onclick="togglePreview()">Предпросмотр</button>
    <button onclick="exportPDF()">Экспорт в PDF</button>
    <button onclick="window.print()">Печать A4 (PDF)</button>
  </div>
</header>

<main>
  <div id="rows">
    <!-- ПЕРВАЯ СТРОКА (шаблон); при добавлении клонируется и очищается -->
    <div class="row">
      <label class="selctl"><input type="checkbox" class="selrow"> выб.</label>
      <button class="delrow" onclick="delRow(this)">Удалить позицию</button>

      <div class="left">
        <div class="imgbox"><img alt=""></div>
        <input class="filectrl" type="file" accept="image/*" onchange="onImg(this)">
      </div>

      <div class="right">
        <div class="table">
          <div class="trow head">
            <div class="tcell">Номер фабрики</div>
            <div class="tcell">Цвет (RU)</div>
            <div class="tcell">Категория</div>
            <div class="tcell">Марка (EN)</div>
          </div>
          <div class="trow">
            <div class="tcell"><input></div>
            <div class="tcell"><input list="dlColors" placeholder=""></div>
            <div class="tcell"><input list="dlDept" placeholder=""></div>
            <div class="tcell"><input list="dlBrands" placeholder=""></div>
          </div>

          <div class="trow subhead">
            <div class="tcell">Размеры</div>
            <div class="tcell">Наименование (отдел)</div>
            <div class="tcell"></div><div class="tcell"></div>
          </div>
          <div class="trow">
            <div class="tcell">
              <div class="chips"></div>
              <input class="sizefree" oninput="syncChipsFromInput(this)" placeholder="например: 36; 37; 38">
            </div>
            <!-- ОДНО поле (input + datalist) -->
            <div class="tcell"><input class="name-input" list="dlName" oninput="syncChipsToCategory(this)" placeholder=""></div>
            <div class="tcell"></div><div class="tcell"></div>
          </div>

          <div class="trow head">
            <div class="tcell">Количество (авто)</div>
            <div class="tcell">Цена</div>
            <div class="tcell">Общая сумма</div>
            <div class="tcell">ИТОГО</div>
          </div>
          <div class="trow summary">
            <div class="tcell"><input class="qty-input" type="number" min="0" step="1" oninput="recalc()"></div>
            <div class="tcell"><input class="price-input" type="number" min="0" step="0.01" oninput="recalc()"></div>
            <div class="tcell sumcell"><span class="sum">—</span></div>
            <div class="tcell sumcell"><span class="sum">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="gtotal"><strong>ИТОГОВАЯ СУММА К ОПЛАТЕ:</strong> <span id="grand">—</span></div>
</main>

<!-- списки -->
<datalist id="dlBrands">
  <option value="Chanel"><option value="Gucci"><option value="Hermes"><option value="Louis Vuitton">
  <option value="Saint Laurent"><option value="Prada"><option value="Dior"><option value="Fendi">
  <option value="Valentino"><option value="Versace"><option value="Zegna"><option value="Burberry">
  <option value="Cartier"><option value="Rolex"><option value="Celine"><option value="Givenchy">
</datalist>
<datalist id="dlColors">
  <option value="Белый"><option value="Бежевый"><option value="Бирюзовый"><option value="Бордовый">
  <option value="Жёлтый"><option value="Зелёный"><option value="Золотой"><option value="Коричневый">
  <option value="Красный"><option value="Матовый"><option value="Многоцветный"><option value="Оливковый">
  <option value="Оранжевый"><option value="Персиковый"><option value="Пудровый"><option value="Прозрачный">
  <option value="Розовый"><option value="Серебристый"><option value="Серый"><option value="Синий">
  <option value="Сиреневый"><option value="Слоновая кость"><option value="Тёмно-синий"><option value="Фиолетовый">
  <option value="Хаки"><option value="Чёрный">
</datalist>
<datalist id="dlDept"><option value="Мужской"><option value="Женский"><option value="Детский"><option value="Унисекс"></datalist>
<datalist id="dlName">
  <option value="Обувь женская"><option value="Обувь мужская"><option value="Обувь детская">
  <option value="Одежда женская"><option value="Одежда мужская"><option value="Детская одежда">
  <option value="Очки"><option value="Часы"><option value="Кольцо"><option value="Браслет">
  <option value="Ремень"><option value="Головной убор"><option value="Сумка женская"><option value="Сумка мужская"><option value="Сумка/Рюкзак">
</datalist>

<script>
function money(n){ return (isFinite(n)?Number(n):0).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}); }
const rowsEl=document.getElementById('rows'); const grandEl=document.getElementById('grand');

/* ===== Сжатие фото для мобильной стабильности ===== */
function compressImage(file, maxW=1600, maxH=1600, quality=0.8){
  return new Promise((resolve,reject)=>{
    const img=new Image();
    const fr=new FileReader();
    fr.onload=()=>{ img.onload=()=>{
      let {width:w,height:h}=img;
      const ratio=Math.min(maxW/w, maxH/h, 1);
      const cw=w*ratio, ch=h*ratio;
      const c=document.createElement('canvas'); c.width=cw; c.height=ch;
      const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,cw,ch);
      c.toBlob(b=>resolve(b), 'image/jpeg', quality);
    }; img.onerror=reject; img.src=fr.result; };
    fr.onerror=reject; fr.readAsDataURL(file);
  });
}

async function onImg(input){
  const f=input.files[0]; if(!f) return;
  const img=input.parentElement.querySelector('img');
  try{
    const blob=await compressImage(f, 1600, 1600, 0.82);
    const rd=new FileReader();
    rd.onload=()=>{ img.src=rd.result; };
    rd.readAsDataURL(blob);
  }catch(e){
    // fallback без сжатия
    const rd=new FileReader(); rd.onload=()=>img.src=rd.result; rd.readAsDataURL(f);
  }
}

const SIZE_MAP={
  'обувь женская':['34','35','35.5','36','36.5','37','37.5','38','38.5','39','40','41'],
  'обувь мужская':['39','40','41','42','43','44','45','46'],
  'обувь детская':['18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','33','34'],
  'одежда женская':['XXS','XS','S','M','L','XL','XXL','42','44','46','48','50','52'],
  'одежда мужская':['XS','S','M','L','XL','XXL','XXXL','44','46','48','50','52','54','56','58','60'],
  'детская одежда':['0–3 мес','3–6 мес','6–9 мес','9–12 мес','1–2 года','2–3 года','3–4 года','4–5 лет','6–7 лет','8–9 лет','10–11 лет','12–13 лет','14–15 лет'],
  'кольцо':['15','15.5','16','16.5','17','17.5','18','18.5','19','19.5','20','20.5','21','21.5','22','US 4','US 5','US 6','US 7','US 8','US 9','US 10','US 11','US 12','EU 48','EU 50','EU 52','EU 54','EU 56','EU 58','EU 60','EU 62','EU 64'],
  'браслет':['16 см','17 см','18 см','19 см','20 см','21 см','22 см'],
  'ремень':['80 см','85 см','90 см','95 см','100 см','105 см','110 см','115 см','120 см'],
  'головной убор':['S (54–55)','M (56–57)','L (58–59)','XL (60–61)'],
  'очки':['48 мм','50 мм','52 мм','54 мм','56 мм','58 мм','60 мм','62 мм'],
  'часы':['36 мм','38 мм','40 мм','41 мм','42 мм','44 мм','45 мм'],
  'сумка женская':['Small','Medium','Large'],
  'сумка мужская':['Small','Medium','Large'],
  'сумка/рюкзак':['Small','Medium','Large']
};

function buildChips(container, items){
  container.innerHTML = items.map(v=>`<span class="chip" data-val="${v}">${v}</span>`).join('');
  container.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click',()=>{ ch.classList.toggle('active'); syncInputFromChips(container); });
  });
}

function uniqueCount(str){ return [...new Set(str.split(/\s*;\s*/).filter(Boolean))].length; }
function setQtyFromSizes(row){
  const free=row.querySelector('.sizefree'); const qty=row.querySelector('.qty-input');
  qty.value = uniqueCount(free.value) || ''; recalc();
}
function syncInputFromChips(container){
  const row=container.closest('.row'); const free=row.querySelector('.sizefree');
  const selected=[...container.querySelectorAll('.chip.active')].map(ch=>ch.dataset.val);
  const manual=free.value.trim()? free.value.split(/\s*;\s*/): [];
  const all=[...new Set(selected.concat(manual).filter(Boolean))];
  free.value=all.join('; '); setQtyFromSizes(row);
}
function syncChipsFromInput(inputEl){
  const row=inputEl.closest('.row'); const container=row.querySelector('.chips');
  const vals=inputEl.value.split(/\s*;\s*/).filter(Boolean);
  container.querySelectorAll('.chip').forEach(ch=>ch.classList.toggle('active', vals.includes(ch.dataset.val)));
  setQtyFromSizes(row);
}
function fillChipsForName(row, nameVal){
  const key=(nameVal||'').toLowerCase().trim();
  const chips=row.querySelector('.chips'); chips.innerHTML='';
  if(!key) return;
  let found=[];
  for(const k in SIZE_MAP){ if(key.includes(k)) { found=SIZE_MAP[k]; break; } }
  if(!found.length){
    if(key.includes('обув')) found=SIZE_MAP['обувь женская'].concat(SIZE_MAP['обувь мужская']);
    else if(key.includes('одеж')) found=SIZE_MAP['одежда женская'].concat(SIZE_MAP['одежда мужская']);
    else if(key.includes('очки')) found=SIZE_MAP['очки'];
    else if(key.includes('час')) found=SIZE_MAP['часы'];
  }
  if(!found.length) return;
  buildChips(chips,found); syncChipsFromInput(row.querySelector('.sizefree'));
}
function syncChipsToCategory(nameInput){ fillChipsForName(nameInput.closest('.row'), nameInput.value); }

function resetRow(el){
  el.querySelectorAll('input').forEach(inp=>{ if(inp.type==='checkbox') inp.checked=false; else inp.value=''; });
  const img=el.querySelector('.imgbox img'); if(img) img.removeAttribute('src');
  el.querySelectorAll('.sum').forEach(s=>s.textContent='—');
  el.querySelector('.chips').innerHTML='';
}

function createEmptyRow(){
  const tpl=rowsEl.firstElementChild.cloneNode(true); resetRow(tpl); return tpl.outerHTML;
}

function addRow(){ rowsEl.insertAdjacentHTML('beforeend', createEmptyRow()); }
function removeAll(){ rowsEl.innerHTML=createEmptyRow(); recalc(); }
function delRow(btn){ btn.closest('.row').remove(); if(!rowsEl.children.length) rowsEl.insertAdjacentHTML('beforeend', createEmptyRow()); recalc(); }
function removeSelected(){
  document.querySelectorAll('.row').forEach(r=>{ const cb=r.querySelector('.selrow'); if(cb&&cb.checked) r.remove(); });
  if(!rowsEl.children.length) rowsEl.insertAdjacentHTML('beforeend', createEmptyRow()); recalc();
}

function recalc(){
  let total=0;
  document.querySelectorAll('.row').forEach(r=>{
    const q=+r.querySelector('.qty-input')?.value||0;
    const p=+r.querySelector('.price-input')?.value||0;
    const s=q*p;
    r.querySelectorAll('.sum').forEach(el=>el.textContent=(q&&p)?money(s):'—');
    total+=s;
  });
  grandEl.textContent=money(total);
}

function togglePreview(){ document.body.classList.toggle('print-preview'); window.scrollTo({top:0}); }
function exportPDF(){ if(!document.body.classList.contains('print-preview')) togglePreview(); setTimeout(()=>window.print(), 50); }

window.addEventListener('DOMContentLoaded',()=>{ resetRow(rowsEl.firstElementChild); });
</script>
</body>
</html>
