<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Накладная “ONE TO ONE” — v22_mobile_with_export</title>
<style>
:root{ --font:12px; --pad:6px; --line:#cfd8e3; --head:#e6f0ff; --sum:#f7f7f7; --chocb:rgba(93,50,23,0.06); --chocbg:rgba(93,50,23,0.01); }
@media print{
  @page{size:A4 portrait;margin:4mm}
  .toolbar,.filectrl,.chips,.selctl,.delrow,.preview-exit{display:none!important}
  header{display:block!important; padding:1mm 0 2mm 0; border:none}
  h1{font-size:14px;margin:0;text-align:center;text-transform:uppercase}
  body{font-size:9.5px}
  .row{grid-template-columns:48mm 1fr; height:50mm; gap:2mm; padding:1mm; margin:0 0 1.2mm 0; border:1px solid var(--line); break-inside:avoid; border-radius:4px; align-items:center}
  .left{height:100%; display:flex; align-items:center; justify-content:center;}
  .imgbox{width:45mm; height:30mm; border:0.4mm solid var(--chocb); background:var(--chocbg); border-radius:2mm; display:flex; align-items:center; justify-content:center; overflow:hidden}
  .imgbox img{width:100%; height:100%; object-fit:contain; object-position:center;}
  .tcell{white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .tcell input, .tcell select{height:17px; line-height:17px; padding:0 3px; font-size:9.5px}
  .gtotal{font-size:12px; padding:3px 6px; margin-top:2mm; justify-content:flex-end}
  .gtotal strong, .gtotal #grand{font-weight:900; font-size:13px}
}

*{box-sizing:border-box} 
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;color:#111;font-size:var(--font)}
header{padding:8px 10px;background:#f7fafc;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:2}
h1{margin:0;text-align:center;font-size:22px;letter-spacing:.3px;text-transform:uppercase}
.toolbar{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px}
button,input,select{font-size:var(--font);padding:var(--pad);border:1px solid #cfd8e3;border-radius:8px;background:#fff}
button.primary{background:#0f62fe;color:#fff;border-color:#0f62fe}
button.danger{background:#ef4444;color:#fff;border-color:#ef4444}
button.secondary{background:#eef2ff}
.preview-exit{display:none; position:fixed; right:10px; top:10px; z-index:5; padding:8px 10px; border-radius:8px; border:1px solid #94a3b8; background:#ffffffcc;}
body.print-preview .preview-exit{display:block;}

main{padding:10px}
/* Desktop layout (как в v21 final.9) */
.row{display:grid;grid-template-columns:180px 1fr; gap:8px; border:1px solid var(--line); border-radius:10px; padding:8px; margin-bottom:8px; background:#fff; position:relative; align-items:center}
.left{display:flex; align-items:center; justify-content:center; height:100%}
.imgbox{border:1px solid var(--chocb); background:var(--chocbg); border-radius:8px; display:flex; align-items:center; justify-content:center; width:170px; height:113px; overflow:hidden}
.imgbox img{display:block;width:100%;height:100%;object-fit:contain;object-position:center;}
.filectrl{width:100%}
.selctl{position:absolute; left:8px; top:8px; display:flex; align-items:center; gap:6px; font-size:11px}
.delrow{position:absolute; right:8px; top:8px; padding:4px 8px; border-radius:8px; border:1px solid #ef4444; color:#ef4444; background:#fff; cursor:pointer}

.right{display:grid;gap:6px}
.table{display:grid; border:1px solid var(--line); border-radius:8px; overflow:hidden}
.trow{display:grid; grid-template-columns: repeat(4, 1fr); border-bottom:1px solid var(--line)}
.tcell{border-right:1px solid var(--line); padding:4px}
.trow .tcell:last-child{border-right:none}
.trow.head{background:var(--head); font-weight:700; text-transform:uppercase; font-size:11px}
.trow.subhead{grid-template-columns: 1fr 1fr 1fr 1fr; background:#f8fafc; font-weight:700; text-transform:uppercase; font-size:11px}
.trow.summary{background:#fff}
.tcell input, .tcell select{width:100%; padding:4px; font-size:12px}
.sumcell{background:var(--sum); font-weight:800; text-align:right}
.gtotal{display:flex; justify-content:flex-end; align-items:center; gap:10px; padding:10px 12px; border:2px solid var(--line); border-radius:10px; background:#fff; margin-top:6px}
.gtotal strong{font-weight:900; letter-spacing:.2px}
#grand{font-weight:900; font-size:16px}

.chips{display:flex; flex-wrap:wrap; gap:6px; margin-bottom:6px}
.chip{background:#f1f5f9; border:1px solid #d1d9e6; border-radius:999px; padding:4px 8px; cursor:pointer; user-select:none}
.chip.active{background:#0f62fe; color:#fff; border-color:#0f62fe}

/* -------- MOBILE ADAPTATION -------- */
@media (max-width: 640px){
  h1{font-size:18px}
  .toolbar{gap:6px}
  .toolbar button{flex:1 1 48%; min-width:44%}
  main{padding:8px}
  .row{grid-template-columns:1fr; align-items:start}
  .left{order:0}
  /* фото на всю ширину экрана, фикс высота */
  .imgbox{width:100%; height:50vw; max-height:280px}
  .filectrl{margin-top:6px}
  .right{order:1}
  .table{border-radius:8px}
  .trow{grid-template-columns:1fr 1fr}
  .trow.head .tcell:nth-child(n+3),
  .trow.subhead .tcell:nth-child(n+3){display:none}
  .trow:nth-of-type(2){grid-template-columns:1fr 1fr}
  .trow:nth-of-type(4){grid-template-columns:1fr 1fr}
  .trow.head:last-of-type, .trow.summary{grid-template-columns:1fr 1fr}
  .tcell input, .tcell select{font-size:16px;padding:10px}
  .sumcell{font-size:16px}
  .selctl,.delrow{top:6px}
  .gtotal{justify-content:space-between; font-size:18px}
  #grand{font-size:20px}
}
</style>
</head>
<body>
<button class="preview-exit" onclick="togglePreview()">⟵ Выйти из предпросмотра</button>
<header>
  <h1>НАКЛАДНАЯ “ONE TO ONE”</h1>
  <div class="toolbar">
    <button class="primary" onclick="addRow()">Добавить позицию</button>
    <button onclick="removeSelected()">Удалить выбранные</button>
    <button class="danger" onclick="removeAll()">Удалить все</button>
    <button class="secondary" onclick="togglePreview()">Предпросмотр</button>
    <button onclick="exportPDF()">Экспорт в PDF</button>
    <button onclick="window.print()">Печать A4 (PDF)</button>
  </div>
</header>
<main>
  <div id="rows">
    <div class="row">
      <label class="selctl"><input type="checkbox" class="selrow"> выб.</label>
      <button class="delrow" onclick="delRow(this)">Удалить позицию</button>
      <div class="left">
        <div class="imgbox"><img alt=""></div>
        <input class="filectrl" type="file" accept="image/*" onchange="onImg(this)">
      </div>
      <div class="right">
        <div class="table">
          <div class="trow head">
            <div class="tcell">Номер фабрики</div>
            <div class="tcell">Цвет (RU)</div>
            <div class="tcell">Категория</div>
            <div class="tcell">Марка (EN)</div>
          </div>
          <div class="trow">
            <div class="tcell"><input></div>
            <div class="tcell"><input list="dlColors"></div>
            <div class="tcell"><input list="dlDept"></div>
            <div class="tcell"><input list="dlBrands"></div>
          </div>

          <div class="trow subhead">
            <div class="tcell">Размеры</div>
            <div class="tcell">Наименование (отдел)</div>
            <div class="tcell"></div>
            <div class="tcell"></div>
          </div>
          <div class="trow">
            <div class="tcell">
              <div class="chips"></div>
              <input class="sizefree" oninput="syncChipsFromInput(this)">
            </div>
            <div class="tcell"><input class="name-input" list="dlName" oninput="syncChipsToCategory(this)"></div>
            <div class="tcell" style="grid-column:3/4"></div>
            <div class="tcell"></div>
          </div>

          <div class="trow head">
            <div class="tcell">Количество (авто)</div>
            <div class="tcell">Цена</div>
            <div class="tcell">Общая сумма</div>
            <div class="tcell">ИТОГО</div>
          </div>
          <div class="trow summary">
            <div class="tcell"><input class="qty-input" type="number" min="0" step="1" oninput="recalc()"></div>
            <div class="tcell"><input class="price-input" type="number" min="0" step="0.01" oninput="recalc()"></div>
            <div class="tcell sumcell"><span class="sum">—</span></div>
            <div class="tcell sumcell"><span class="sum">—</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="gtotal"><strong>ИТОГОВАЯ СУММА К ОПЛАТЕ:</strong><span id="grand">—</span></div>
</main>

<datalist id="dlBrands"><option value='Chanel'><option value='Gucci'><option value='Hermes'><option value='Louis Vuitton'><option value='Saint Laurent'><option value='Prada'><option value='Dior'><option value='Fendi'><option value='Valentino'><option value='Versace'><option value='Zegna'><option value='Burberry'><option value='Cartier'><option value='Rolex'><option value='Celine'><option value='Givenchy'></datalist>
<datalist id="dlColors"><option value='Белый'><option value='Бежевый'><option value='Бирюзовый'><option value='Бордовый'><option value='Жёлтый'><option value='Зелёный'><option value='Золотой'><option value='Коричневый'><option value='Красный'><option value='Матовый'><option value='Многоцветный'><option value='Оливковый'><option value='Оранжевый'><option value='Персиковый'><option value='Пудровый'><option value='Прозрачный'><option value='Розовый'><option value='Серебристый'><option value='Серый'><option value='Синий'><option value='Сиреневый'><option value='Слоновая кость'><option value='Тёмно-синий'><option value='Фиолетовый'><option value='Хаки'><option value='Чёрный'></datalist>
<datalist id="dlDept"><option value="Мужской"><option value="Женский"><option value="Детский"><option value="Унисекс"></datalist>
<datalist id="dlName"><option value='Багаж'><option value='Бижутерия'><option value='Браслет'><option value='Верхняя одежда'><option value='Галстук'><option value='Головной убор'><option value='Джинсы'><option value='Жилет'><option value='Зонт'><option value='Кольцо'><option value='Кошелёк'><option value='Куртка'><option value='Нижнее бельё'><option value='Носки'><option value='Обувь женская'><option value='Обувь мужская'><option value='Обувь детская'><option value='Очки'><option value='Пальто'><option value='Пиджак'><option value='Платок'><option value='Платье'><option value='Пояс/Ремень'><option value='Рубашка'><option value='Сандалии'><option value='Сапоги'><option value='Свитер'><option value='Свитшот'><option value='Серьги'><option value='Сумка женская'><option value='Сумка мужская'><option value='Сумка/Рюкзак'><option value='Толстовка'><option value='Тренч'><option value='Футболка'><option value='Худи'><option value='Часы'><option value='Шапка'><option value='Шарф'><option value='Шорты'><option value='Юбка'></datalist>

<script>
function money(n){ return (isFinite(n)?Number(n):0).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2}); }
const rowsEl=document.getElementById('rows'); const grandEl=document.getElementById('grand');

function onImg(input){
  const f=input.files[0]; if(!f) return;
  const img=input.parentElement.querySelector('img');
  const rd=new FileReader();
  rd.onload=()=>{ img.src=rd.result; };
  rd.readAsDataURL(f);
}

const SIZE_MAP = {
  'обувь женская': ['34','35','35.5','36','36.5','37','37.5','38','38.5','39','40','41'],
  'обувь мужская': ['39','40','41','42','43','44','45','46'],
  'обувь детская': ['18','19','20','21','22','23','24','25','26','27','28','29','30','31','32','33','34'],
  'одежда женская': ['XXS','XS','S','M','L','XL','XXL','42','44','46','48','50','52'],
  'одежда мужская': ['XS','S','M','L','XL','XXL','XXXL','44','46','48','50','52','54','56','58','60'],
  'детская одежда': ['0–3 мес','3–6 мес','6–9 мес','9–12 мес','1–2 года','2–3 года','3–4 года','4–5 лет','6–7 лет','8–9 лет','10–11 лет','12–13 лет','14–15 лет'],
  'кольцо': ['15','15.5','16','16.5','17','17.5','18','18.5','19','19.5','20','20.5','21','21.5','22','US 4','US 5','US 6','US 7','US 8','US 9','US 10','US 11','US 12','EU 48','EU 50','EU 52','EU 54','EU 56','EU 58','EU 60','EU 62','EU 64'],
  'браслет': ['16 см','17 см','18 см','19 см','20 см','21 см','22 см'],
  'ремень': ['80 см','85 см','90 см','95 см','100 см','105 см','110 см','115 см','120 см'],
  'головной убор': ['S (54–55)','M (56–57)','L (58–59)','XL (60–61)'],
  'очки': ['48 мм','50 мм','52 мм','54 мм','56 мм','58 мм','60 мм','62 мм'],
  'часы': ['36 мм','38 мм','40 мм','41 мм','42 мм','44 мм','45 мм'],
  'сумка женская': ['Small','Medium','Large'],
  'сумка мужская': ['Small','Medium','Large'],
  'сумка/рюкзак': ['Small','Medium','Large']
};

function buildChips(container, items){
  container.innerHTML = items.map(v=>`<span class="chip" data-val="${v}">${v}</span>`).join('');
  container.querySelectorAll('.chip').forEach(ch=>{
    ch.addEventListener('click',()=>{
      ch.classList.toggle('active');
      syncInputFromChips(container);
    });
  });
}

function uniqueCount(str){ return [...new Set(str.split(/\s*;\s*/).filter(Boolean))].length; }
function setQtyFromSizes(row){
  const free = row.querySelector('.sizefree');
  const qty = row.querySelector('.qty-input');
  qty.value = uniqueCount(free.value) || '';
  recalc();
}
function syncInputFromChips(container){
  const row = container.closest('.row');
  const free = row.querySelector('.sizefree');
  const selected = [...container.querySelectorAll('.chip.active')].map(ch=>ch.dataset.val);
  const manual = free.value.trim()? free.value.split(/\s*;\s*/): [];
  const all = [...new Set(selected.concat(manual).filter(Boolean))];
  free.value = all.join('; ');
  setQtyFromSizes(row);
}
function syncChipsFromInput(inputEl){
  const row = inputEl.closest('.row');
  const container = row.querySelector('.chips');
  const vals = inputEl.value.split(/\s*;\s*/).filter(Boolean);
  container.querySelectorAll('.chip').forEach(ch=>{
    ch.classList.toggle('active', vals.includes(ch.dataset.val));
  });
  setQtyFromSizes(row);
}
function fillChipsForName(row, nameVal){
  const key = (nameVal||'').toLowerCase().trim();
  const chips = row.querySelector('.chips');
  chips.innerHTML = '';
  if (!key) return;
  let found = [];
  for (const k in SIZE_MAP){ if (key.includes(k)) { found = SIZE_MAP[k]; break; } }
  if (!found.length){
    if (key.includes('обув')) found = SIZE_MAP['обувь женская'].concat(SIZE_MAP['обувь мужская']);
    else if (key.includes('одеж')) found = SIZE_MAP['одежда женская'].concat(SIZE_MAP['одежда мужская']);
    else if (key.includes('очки')) found = SIZE_MAP['очки'];
    else if (key.includes('час')) found = SIZE_MAP['часы'];
  }
  if (!found.length) return;
  buildChips(chips, found);
  syncChipsFromInput(row.querySelector('.sizefree'));
}
function syncChipsToCategory(nameInput){
  const row = nameInput.closest('.row');
  fillChipsForName(row, nameInput.value);
}

function resetRow(el){
  el.querySelectorAll('input').forEach(inp=>{
    if (inp.type==='checkbox') inp.checked=false; else inp.value='';
  });
  const img = el.querySelector('.imgbox img'); if (img) img.removeAttribute('src');
  el.querySelectorAll('.sum').forEach(s=>s.textContent='—');
  const chips = el.querySelector('.chips'); chips.innerHTML='';
}

function createEmptyRow(){
  const tpl = rowsEl.firstElementChild.cloneNode(true);
  resetRow(tpl);
  return tpl.outerHTML;
}

function addRow(){ rowsEl.insertAdjacentHTML('beforeend', createEmptyRow()); }
function removeAll(){ rowsEl.innerHTML = createEmptyRow(); recalc(); }
function delRow(btn){
  const row = btn.closest('.row'); row.remove();
  if (!rowsEl.children.length) rowsEl.insertAdjacentHTML('beforeend', createEmptyRow());
  recalc();
}
function removeSelected(){
  document.querySelectorAll('.row').forEach(r=>{
    const cb = r.querySelector('.selrow'); if (cb && cb.checked) r.remove();
  });
  if (!rowsEl.children.length) rowsEl.insertAdjacentHTML('beforeend', createEmptyRow());
  recalc();
}

function recalc(){
  let total=0;
  document.querySelectorAll('.row').forEach(r=>{
    const q=+r.querySelector('.qty-input')?.value||0;
    const p=+r.querySelector('.price-input')?.value||0;
    const s=q*p;
    r.querySelectorAll('.sum').forEach(el=>el.textContent=(q&&p)?money(s):'—');
    total+=s;
  });
  grandEl.textContent=money(total);
}

function togglePreview(){ document.body.classList.toggle('print-preview'); window.scrollTo({top:0}); }
function exportPDF(){ if (!document.body.classList.contains('print-preview')) togglePreview(); setTimeout(()=>window.print(), 50); }

window.addEventListener('DOMContentLoaded',()=>{
  const firstRow = rowsEl.firstElementChild;
  resetRow(firstRow);
});
</script>
</body>
</html>
